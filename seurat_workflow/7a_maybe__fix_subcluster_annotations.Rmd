---
title: "Fix Subclustering of integrated data"
description:
author: "Aaron M. Allen"
date: 'Last update: `r date()`'
output:
  html_document:
    number_sections: true
    code_folding: show
    code_download: true
    theme: cerulean
    df_print: paged
    fig_width: 8.5
    fig_height: 5
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 6
---



```{css, echo = FALSE}
pre, code {white-space:pre !important; overflow-x:auto}
.tocify-item {white-space:pre}
```



```{r echo = FALSE, cache = FALSE}

```


```{r setup, echo = FALSE, cache = FALSE}
ggplot2::theme_set(ggplot2::theme_grey())

rmd_name <- gsub(pattern = ".Rmd", replacement = "", x = knitr::current_input(), ignore.case = TRUE)
knitr::opts_chunk$set(dev = c("png", "cairo_pdf"),
                      fig.align = "center",
                      fig.height = 5,
                      fig.width = 8.5,
                      dpi = 300,
                      pdf.options(encoding = "ISOLatin9.enc"),
                      fig.path = paste0("../analyses/figures/", rmd_name, "-",
                                        format(Sys.time(), "%Y%m%d_%H%M%S"), "/"),
                      fig.retina = 1,
                      warning = TRUE,
                      message = TRUE)
```



# Setup

## Job_ID = `r commandArgs(trailingOnly = TRUE)[2]`


## Start time

```{r start-time}
set.seed(12021)
today <- format(Sys.time(), "%Y%m%d_%H%M%S")
total_start_time <- Sys.time()
total_start_time
```






## Parameters



```{r params}
params_file <- commandArgs(trailingOnly = TRUE)[3]
params_path <- paste0("../src/param_files/", params_file)
print(paste0("The params file is :   ", params_path))
```

```{r, class.source = 'fold-hide', code = readLines(params_path)}
```



```{r params-manual}
source("param_files/pipeline_R_params__PUBnofacs_v1_cb.R")
```





## Libraries

```{r packages-etc, warning = FALSE, message = FALSE}
library(Seurat)
library(tidyverse)
library(cowplot)
library(pheatmap)
library(colorspace)
```





## Load the data


```{r load-data}
if (remove_doublets == FALSE && remove_ambient == FALSE) {
    path_modifier <- ""
}
if (remove_doublets == TRUE && remove_ambient == FALSE) {
    path_modifier <- "_doublets_removed"
}
if (remove_doublets == FALSE && remove_ambient == TRUE) {
    path_modifier <- "_ambient_removed"
}
if (remove_doublets == TRUE && remove_ambient == TRUE) {
    path_modifier <- "_doublets_removed_ambient_removed"
}

integrated <- read_rds(file = paste0(objects_path,
                                    dataset, "_",
                                    input_type, "_",
                                    normalization, "_",
                                    integration, "_",
                                    "integrated_seurat",
                                    path_modifier,
                                    "_annotated.rds")
                            )
```




```{r}
main_objs_list <- list.files("../analyses/rds_files/") %>%
    str_subset("list", negate = TRUE) %>%
    str_subset("subclusting.rds") %>%
    str_subset("tsne", negate = TRUE)
main_objs_list
```





```{r}
main_objs <- list()
for (i in seq_along(main_objs_list)) {
    main_objs[[i]] <- read_rds(paste0("../analyses/rds_files/", main_objs_list[[i]]))
}
names(main_objs) <- main_objs_list %>%
    str_remove("New_Meta_cbNeuron_PUBnofacs_noPolIII_v1_alevin_LogNormalize_harmony_integrated_seurat_doublets_removed_") %>%
    str_remove("_subclusting.rds")
main_objs
```




# Fix annotations:


Let's start with the easy ones



## Monoamine


```{r fig.width = 10, fig.height = 10}
DimPlot(object = main_objs[["Monoaminergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap",
        label = TRUE) +
    NoAxes() +
    coord_fixed()
```




```{r fig.width = 10, fig.height = 8}
DimPlot(object = main_objs[["Monoaminergic"]],
        group.by = "RNA_snn_res.6",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap",
        label = TRUE) +
    NoAxes() +
    coord_fixed()
```


```{r fig.height=6, fig.width=6}
my_res <- "RNA_snn_res.6"
Idents(main_objs[["Monoaminergic"]]) <- main_objs[["Monoaminergic"]]@meta.data[[my_res]]
all_clusters <- sort(unique(main_objs[["Monoaminergic"]]@meta.data[[my_res]]))
for (i in seq_along(all_clusters)) {
    my_cells <- WhichCells(object = main_objs[["Monoaminergic"]], idents = all_clusters[[i]])
    p1 <- DimPlot(object = main_objs[["Monoaminergic"]],
                  cells.highlight = my_cells,
                  cols = "lightsteelblue2",
                  cols.highlight = "black",
                  sizes.highlight = 0.4,
                  pt.size = 0.1,
                  raster = FALSE,
                  reduction = "umap") +
        ggtitle(paste0("Cluster ", all_clusters[[i]])) +
        NoLegend() +
        coord_fixed()
    plot(p1)
}
```





```{r fig.width = 14, fig.height = 10}
FeaturePlot(object = main_objs[["Monoaminergic"]],
            features = c("Fer2", "ple", "DAT", "SerT", "Trh", "Tdc2", "Tbh", "Hdc", "prt", "Vmat", "Imp", "dati"),
            # ncol = 3,
            pt.size = 1,
            cols = c("lightsteelblue2", "black"),
            reduction = "umap",
            order = TRUE,
            coord.fixed = TRUE,
            combine = FALSE)
```



```{r}
avg_exp <- AverageExpression(object = main_objs[["Monoaminergic"]], 
                             assays = "RNA", 
                             slot = "counts",
                             features = c("Fer2", "ple", "DAT", "SerT", "Trh", "Tdc2", "Tbh", "Hdc", "TfAP-2", "Imp", "dati", "prt"),
                             group.by = "RNA_snn_res.6")
```


```{r}
scaled_exp <- avg_exp$RNA %>% 
    as.data.frame() %>% 
    rownames_to_column("gene") %>% 
    gather("cluster", "expression", -gene) %>% 
    spread(gene, expression) %>% 
    column_to_rownames("cluster") %>% 
    as.matrix() %>% 
    scale() %>% 
    as.data.frame() %>% 
    rownames_to_column("cluster") %>% 
    gather("gene", "expression", -cluster) 
scaled_exp
```





```{r fig.width=16, fig.height=4}
scaled_exp %>% 
    spread(cluster, expression) %>% 
    column_to_rownames("gene") %>% 
    pheatmap::pheatmap(.,
         breaks=seq(-2,2,0.1),
         color = diverging_hcl(40, "Vik"),
         border_color = NA,
         cluster_rows = T,
         cluster_cols = T,
         #fontsize = 16,
         angle_col = 90)
```


```{r}
scaled_exp %>% 
    spread(gene, expression) %>% 
    # filter(Fer2 > 0.1 & (DAT > 0 | ple > 0), dati > 0.1) %>% 
    filter(Fer2 < 0.1 & (DAT > 0 | ple > 0), dati < 0.1) %>% 
    pull(cluster) %>%
    as.numeric() %>% 
    sort() %>% 
    paste(., sep="' '", collapse=", ")
```




```{r}
fixed_ann_df <- FetchData(object = main_objs[["Monoaminergic"]], 
          vars = c("RNA_snn_res.6")) %>% 
    rownames_to_column("cell_id") %>% 
    mutate(fixed_ann = "unknown") %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(26), "His", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(1, 3, 4, 5, 7, 10, 14, 22, 32, 33, 41, 54, 57, 58, 31,15,2), "PAM", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(0, 8, 13, 38, 44), "Oct", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(11, 27, 29, 30, 37, 55), "Tyr", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(6, 20, 23, 24, 28, 35, 36, 40, 42, 45, 48, 49, 51, 52), "Ser", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(16, 17, 18, 19, 21, 25, 28, 34, 39, 43, 46, 47, 50, 53, 56), "DAN", fixed_ann)) %>% 
    # mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(), "", fixed_ann)) %>% 
    # mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(), "", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(RNA_snn_res.6 %in% c(9), "garbage", fixed_ann))
fixed_ann_df
```



```{r}
main_objs[["Monoaminergic"]] <- AddMetaData(object = main_objs[["Monoaminergic"]], metadata = fixed_ann_df$fixed_ann, col.name = "fixed_ann")
```



```{r fig.width = 16, fig.height = 10}
DimPlot(object = main_objs[["Monoaminergic"]],
        group.by = "fixed_ann",
        pt.size = 2,
        raster = FALSE,
        reduction = "umap") +
    NoAxes() +
    coord_fixed()
```




```{r fig.width = 14, fig.height = 10}
FeaturePlot(object = main_objs[["Monoaminergic"]],
            features = c("percent_hsp", "percent_mt"),
            # ncol = 3,
            pt.size = 1,
            cols = c("lightsteelblue2", "black"),
            reduction = "umap",
            order = TRUE,
            coord.fixed = TRUE,
            combine = FALSE)
```





```{r fig.width = 14, fig.height = 10}
FeaturePlot(object = main_objs[["Monoaminergic"]],
            features = c("nCount_RNA"),
			min.cutoff = 1000,
			max.cutoff = 6000,
            pt.size = 1,
            cols = c("lightsteelblue2", "black"),
            reduction = "umap",
            order = TRUE,
            coord.fixed = TRUE,
            combine = FALSE)
```


<!-- ```{r fig.width = 16, fig.height = 10} -->
<!-- DimPlot(object = main_objs[["Monoaminergic"]], -->
<!--         group.by = "RNA_snn_res.6", -->
<!--         pt.size = 0.4, -->
<!--         raster = FALSE, -->
<!--         reduction = "umap", -->
<!--         label = TRUE) + -->
<!--     NoLegend() + -->
<!--     NoAxes() + -->
<!--     coord_fixed() -->
<!-- FeaturePlot(object = main_objs[["Monoaminergic"]], -->
<!--             features = c("Tbh"), -->
<!--             pt.size = 0.4, -->
<!--             cols = c("lightsteelblue2", "black"), -->
<!--             reduction = "umap", -->
<!--             order = TRUE, -->
<!--             coord.fixed = TRUE) + -->
<!--     NoLegend() + -->
<!--     NoAxes() -->
<!-- ``` -->





## Kenyon Cells


```{r fig.width = 14, fig.height = 10}
umaps <- names(main_objs[["Kenyon_cell"]]@reductions) %>% str_subset("umap") %>% str_subset("pcs")
for (i in seq_along(umaps)) {
    p1 <- DimPlot(object = main_objs[["Kenyon_cell"]],
                  group.by = "merged_clusters",
                  pt.size = 0.4,
                  raster = FALSE,
                  reduction = umaps[[i]],
                  label = TRUE) +
            ggtitle(umaps[[i]]) +
            # NoAxes() +
            coord_fixed()
    plot(p1)
}
```


```{r fig.width = 14, fig.height = 10}
tsnes <- names(main_objs[["Kenyon_cell"]]@reductions) %>% str_subset("tsne") %>% str_subset("pcs")
for (i in seq_along(tsnes)) {
    p1 <- DimPlot(object = main_objs[["Kenyon_cell"]],
                  group.by = "merged_clusters",
                  pt.size = 0.4,
                  raster = FALSE,
                  reduction = tsnes[[i]],
                  label = TRUE) +
            ggtitle(umaps[[i]]) +
            # NoAxes() +
            coord_fixed()
    plot(p1)
}
```



```{r fig.width = 14, fig.height = 10}
kc_genes <- c("ey", "Pka-C1", "Dop1R2")
for (i in seq_along(kc_genes)) {
    p1 <- FeaturePlot(object = main_objs[["Kenyon_cell"]],
                      features = kc_genes[[i]],
                      pt.size = 0.4,
                      cols = c("lightsteelblue2", "black"),
                      reduction = "umap",
                      order = TRUE) +
        coord_fixed()
    plot(p1)
}
```




```{r fig.width = 14, fig.height = 10}
dev_genes <- c("Imp", "dati", "br", "pdm3", "mamo", "pros")
for (i in seq_along(dev_genes)) {
    p1 <- FeaturePlot(object = main_objs[["Kenyon_cell"]],
                      features = dev_genes[[i]],
                      pt.size = 0.4,
                      cols = c("lightsteelblue2", "black"),
                      reduction = "umap_200pcs",
                      order = TRUE) +
        coord_fixed()
    plot(p1)
}
```



```{r fig.width = 14, fig.height = 10}
genes <- c("VAChT", "ChT", "VGlut", "CG46448", "Gad1", "CG14989")
plist <- FeaturePlot(object = main_objs[["Kenyon_cell"]],
           reduction = "umap_200pcs", 
           features = genes,
           combine = FALSE,
           ncol = 1,
           pt.size = 0.4, 
           min.cutoff = 0.5,
		   max.cutoff = 2,
		   # slot = "counts",
           cols = c("lightsteelblue2", "black"), 
           raster = FALSE,
           raster.dpi = c(1024, 1024),
           order = TRUE,
           coord.fixed = TRUE)

for (i in seq_along(plist)) {
	plist[[i]]$layers[[1]]$aes_params$alpha = .1
	plot(plist[[i]])
}
```







ab_KC	alpha and beta lobe subset of kenyon cells	lbm	crb	Cks85A	Tsp42En	Eip93F
prime_KC	alpha' and beta' lobe subset of kenyon cells	CG8641	Gr77a	Lac	CG42322
y_KC	gamma lobe subset of kenyon cells	CG13055	Lgr3	GstD11	CAH2	CG32204	ab


```{r fig.width = 18, fig.height = 12}
FeaturePlot(object = main_objs[["Kenyon_cell"]],
            features = c("lbm", "Gr77a", "CG13055", "crb", "CG8641", "Lgr3"),
            ncol = 3,
            pt.size = 0.1,
            cols = c("lightsteelblue2", "black"),
            reduction = "umap_200pcs",
            order = TRUE, 
            coord.fixed = TRUE)
```


```{r fig.width = 18, fig.height = 12}
FeaturePlot(object = main_objs[["Kenyon_cell"]],
            features = c("sNPF", "Lac", "ab", "Eip93F", "CG8641", "CAH2"),
            ncol = 3,
            pt.size = 0.1,
            cols = c("lightsteelblue2", "black"),
            reduction = "umap_200pcs",
            order = TRUE,
            coord.fixed = TRUE)
```






```{r fig.width = 10, fig.height = 6}
DimPlot(object = main_objs[["Kenyon_cell"]],
        group.by = "merged_clusters",
        pt.size = 1,
        raster = FALSE,
        reduction = "umap",
        label = TRUE) +
        NoAxes() +
        coord_fixed()
```


a/b
ap/bp
y

```{r}
sort(unique(as.numeric(as.character(main_objs[["Kenyon_cell"]]$merged_clusters))))
```


```{r}
fixed_ann_df <- FetchData(object = main_objs[["Kenyon_cell"]], 
          vars = c("merged_clusters")) %>% 
    rownames_to_column("cell_id") %>% 
    mutate(fixed_ann = "unknown") %>% 
    mutate(fixed_ann = if_else(merged_clusters %in% c(3,8), "ap/bp", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(merged_clusters %in% c(1,12,4,2,7,6), "a/b", fixed_ann)) %>% 
    mutate(fixed_ann = if_else(merged_clusters %in% c(11,13,14,0,10,5), "y", fixed_ann))
fixed_ann_df
```



```{r}
main_objs[["Kenyon_cell"]] <- AddMetaData(object = main_objs[["Kenyon_cell"]], metadata = fixed_ann_df$fixed_ann, col.name = "fixed_ann")
```





```{r fig.width = 14, fig.height = 10}
DimPlot(object = main_objs[["Kenyon_cell"]],
        group.by = "fixed_ann",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap") +
    NoAxes() +
    coord_fixed()
```























## GABA




```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```


```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```



```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.2",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.4",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.6",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```



```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.2",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.4",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "RNA_snn_res.6",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```



```{r fig.height=10, fig.width=18}
genes <- c("VAChT", "ChT", "VGlut", "CG46448", "Gad1", "CG14989")
plist <- FeaturePlot(object = main_objs[["GABAergic"]],
           reduction = "umap_200pcs", 
           features = genes,
           combine = FALSE,
           ncol = 1,
           pt.size = 0.4, 
           min.cutoff = 0.5,
		   max.cutoff = 2,
		   # slot = "counts",
           cols = c("lightsteelblue2", "black"), 
           raster = FALSE,
           raster.dpi = c(1024, 1024),
           order = TRUE,
           coord.fixed = TRUE)

for (i in seq_along(plist)) {
	plist[[i]]$layers[[1]]$aes_params$alpha = .1
	plot(plist[[i]])
}
```



```{r}
fixed_ann <- main_objs[["GABAergic"]]@meta.data %>%
    select(RNA_snn_res.2) %>%
    rownames_to_column("cell_id") %>%
    mutate(fixed_ann = as.character(RNA_snn_res.2)) %>%
    pull(fixed_ann)
main_objs[["GABAergic"]] <- AddMetaData(object = main_objs[["GABAergic"]], metadata = fixed_ann, col.name = "fixed_ann")
```




```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["GABAergic"]],
        group.by = "fixed_ann",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```








## Glut





```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Glutamatergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```




```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Glutamatergic"]],
        group.by = "RNA_snn_res.2",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["Glutamatergic"]],
        group.by = "RNA_snn_res.4",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["Glutamatergic"]],
        group.by = "RNA_snn_res.6",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```





```{r fig.height=10, fig.width=18}
genes <- c("VAChT", "ChT", "VGlut", "CG46448", "Gad1", "CG14989")
plist <- FeaturePlot(object = main_objs[["Glutamatergic"]],
           reduction = "umap_200pcs", 
           features = genes,
           combine = FALSE,
           ncol = 1,
           pt.size = 0.4, 
           min.cutoff = 0.5,
		   max.cutoff = 2,
		   # slot = "counts",
           cols = c("lightsteelblue2", "black"), 
           raster = FALSE,
           raster.dpi = c(1024, 1024),
           order = TRUE,
           coord.fixed = TRUE)

for (i in seq_along(plist)) {
	plist[[i]]$layers[[1]]$aes_params$alpha = .1
	plot(plist[[i]])
}
```

```{r}
fixed_ann <- main_objs[["Glutamatergic"]]@meta.data %>%
    select(RNA_snn_res.2) %>%
    rownames_to_column("cell_id") %>%
    mutate(fixed_ann = as.character(RNA_snn_res.2)) %>%
    pull(fixed_ann)
main_objs[["Glutamatergic"]] <- AddMetaData(object = main_objs[["Glutamatergic"]], metadata = fixed_ann, col.name = "fixed_ann")
```





```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Glutamatergic"]],
        group.by = "fixed_ann",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```







## Achol






```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```





```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "merged_clusters",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```


```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "RNA_snn_res.2",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "RNA_snn_res.4",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])

p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "RNA_snn_res.6",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoLegend() +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```





```{r fig.height=10, fig.width=18}
genes <- c("VAChT", "ChT", "VGlut", "CG46448", "Gad1", "CG14989")
plist <- FeaturePlot(object = main_objs[["Cholinergic"]],
           reduction = "umap_200pcs", 
           features = genes,
           combine = FALSE,
           ncol = 1,
           pt.size = 0.4, 
           min.cutoff = 0.5,
		   max.cutoff = 2,
		   # slot = "counts",
           cols = c("lightsteelblue2", "black"), 
           raster = FALSE,
           raster.dpi = c(1024, 1024),
           order = TRUE,
           coord.fixed = TRUE)

for (i in seq_along(plist)) {
	plist[[i]]$layers[[1]]$aes_params$alpha = .1
	plot(plist[[i]])
}
```

```{r}
fixed_ann <- main_objs[["Cholinergic"]]@meta.data %>%
    select(RNA_snn_res.4) %>%
    rownames_to_column("cell_id") %>%
    mutate(fixed_ann = as.character(RNA_snn_res.4)) %>%
    pull(fixed_ann)
main_objs[["Cholinergic"]] <- AddMetaData(object = main_objs[["Cholinergic"]], metadata = fixed_ann, col.name = "fixed_ann")
```





```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "fixed_ann",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "umap_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```




```{r fig.width = 18, fig.height = 10}
p1 <- DimPlot(object = main_objs[["Cholinergic"]],
        group.by = "fixed_ann",
        pt.size = 0.4,
        raster = FALSE,
        reduction = "tsne_200pcs",
        label = TRUE) +
    NoAxes() +
    coord_fixed()

p1[[1]]$layers[[1]]$aes_params$alpha = .1
plot(p1[[1]])
```

















































# Save


```{r}
main_objs_list <- list.files("../analyses/rds_files/") %>%
    str_subset("list", negate = TRUE) %>%
    str_subset("subclusting.rds") %>%
    str_subset("tsne", negate = TRUE)
main_objs_list
```

```{r}
names(main_objs)
```



```{r}
for (i in seq_along(main_objs)) {
   write_rds(x = main_objs[[i]], file = paste0("../analyses/rds_files/", main_objs_list[[i]]))
}
```











# Session info

```{r session-info}
sessionInfo()
```











